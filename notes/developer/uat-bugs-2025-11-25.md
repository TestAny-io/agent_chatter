# UAT Bug 记录 - 2025-11-25

## 观察 1: Claude 发送两次 [Debug][Send] 而 Codex/Gemini 只有一次

### 现象
- Claude (max): 第 6-37 行出现两次 `[Debug][Send]`
  - 第 6 行: `[Debug][Send] to max` - 发送 `[MESSAGE]` 部分
  - 第 10 行: `[Debug][Send] systemFlag (for max):` - 发送 systemFlag 部分
- Codex (sarah): 第 44-76 行只有一次 `[Debug][Send]`
- Gemini (carol): 第 84-114 行只有一次 `[Debug][Send]`

### 原因
Claude 使用 `--append-system-prompt` 参数（官方文档确认）：
- 根据 Claude Code 文档：`--append-system-prompt` 将自定义文本**追加到默认 system prompt 的末尾**
- 我们的代码 `AgentManager.ts:192-193` 使用此参数传递 member 的 system instruction
- Codex/Gemini 不支持这个参数，所以 system instruction 被嵌入到主 prompt 的 `[SYSTEM]` 部分

### 结论
**这不是 Bug，是预期行为。** 两次日志输出只是显示方式不同：
1. 主消息通过 stdin 发送
2. System prompt 通过 `--append-system-prompt` CLI 参数发送（追加到 Claude 默认 system prompt 末尾）

实际上 Claude 只被调用一次，`--append-system-prompt` 是 CLI 参数的一部分。

---

## Bug 2: 设计文档与代码实现的 Prompt Section 顺序不一致

### 现象
设计文档规定的 prompt section 顺序与实际代码实现不一致。

### 设计文档规定
根据 `design/prompt-builder.md` 和 `design/adapter-self-contained-refactor.md`：
- 顺序应为：`[SYSTEM] → [CONTEXT] → [MESSAGE]`
- **没有 `[TASK]` 或 `[TEAM_TASK]` 部分**

### 实际代码实现
`src/utils/PromptBuilder.ts:156-157`：
```typescript
// Inline for others: SYSTEM -> TEAM_TASK -> CONTEXT -> MESSAGE
prompt = `${systemSection}${teamTaskSection}${contextSection}${messageSection}`.trim();
```
实际顺序：`[SYSTEM] → [TEAM_TASK] → [CONTEXT] → [MESSAGE]`

### 结论
**这是文档 Bug**。`[TEAM_TASK]` 是后来添加的功能，但设计文档没有同步更新。

### 待修复
- [ ] 更新 `design/prompt-builder.md` 添加 `[TEAM_TASK]` section 说明
- [ ] 更新 `design/adapter-self-contained-refactor.md` 同步顺序说明
- [ ] 确认当前的 section 顺序是否正确（SYSTEM → TEAM_TASK → CONTEXT → MESSAGE）

---

## Bug 3: 后续轮次 prompt 缺少 [TEAM_TASK] 和 [CONTEXT]

### 现象
第三次轮到 Max (Claude) 发言时（debug.log 第 478-508 行），prompt 格式错误：
- `[MESSAGE]` 出现在最前面
- 缺少 `[TEAM_TASK]` 部分
- 缺少 `[CONTEXT]` 部分（对话历史）

对比第一次调用是正确的，包含完整的 sections。

### 根因
`ConversationCoordinator.ts` 第 529-535 行调用 `buildPrompt` 时**没有传递 `teamTask` 参数**：

```typescript
const prompt = buildPrompt({
  agentType: normalizeAgentType(member.agentType),
  systemInstructionText: member.systemInstruction,
  instructionFileText: member.instructionFileText,
  contextMessages,
  message
  // 缺少：teamTask: this.session?.teamTask
});
```

### 修复方案
添加 `teamTask: this.session?.teamTask` 到 `buildPrompt` 调用中。

### 状态
- [ ] 修复代码
- [ ] 添加单元测试验证

---

## Bug 4: Gemini 的 JSONL 解析把 user 消息也当成 assistant 输出

### 现象
Carol (Gemini) 的回复被存入 session 时，内容变成了完整的 prompt（包含系统指令），而不是实际回复。

导致后续 agent 的 `[CONTEXT]` 里出现 Carol 的系统提示词（两遍！）

### 根因
`JsonlMessageFormatter.ts` 第 82-86 行：
```typescript
// Gemini: message content (delta or full)
if (obj.type === 'message' && typeof obj.content === 'string') {
  parts.push(stripAnsi(obj.content));
  continue;
}
```

Gemini 的 JSONL 输出格式：
```json
// 第一条：role=user（我们发送的 prompt）
{"type":"message","role":"user","content":"Instructions:\nYou are Carol...完整prompt..."}

// 第二条：role=assistant（Gemini 的实际回复）
{"type":"message","role":"assistant","content":"请问有什么设计任务需要我协助吗？","delta":true}
```

代码没有检查 `role` 字段，把 `role=user` 的消息也当成了输出！

### 修复方案
```typescript
// Gemini: message content (delta or full) - only assistant messages
if (obj.type === 'message' && obj.role === 'assistant' && typeof obj.content === 'string') {
  parts.push(stripAnsi(obj.content));
  continue;
}
```

### 状态
- [ ] 修复 JsonlMessageFormatter.ts
- [ ] 添加单元测试

### 影响
此 Bug 导致了 Bug 5（Context 递归污染），是最严重的根因之一。

---

## Bug 5: Context 递归污染（雪球效应）

### 现象
Gemini (Carol) 的 prompt 中 "Conversation so far" 部分出现**多层嵌套**：
- 第一层：Carol 的"消息"内容是完整的 prompt（包含系统指令 + 上一次的 context）
- 第二层：上一次的 context 里又包含 Carol 更早的"消息"（又是完整 prompt）
- **无限嵌套**，context 越来越大

### 根因链条
```
Bug 4 (Gemini JSONL 解析)
    ↓
Carol 的回复被错误存储为完整 prompt
    ↓
完整 prompt 包含上次的 "Conversation so far"
    ↓
下一轮，错误的"回复"被放进新 context
    ↓
递归嵌套，雪球效应
```

### 示例（debug.log 第 646-858 行）
```
Instructions:
You are Carol...（系统指令）

Conversation so far:
- Carol -> kailai: Instructions:        ← Carol 的"消息"竟然是完整 prompt！
  You are Carol...（系统指令又来一遍）
  Conversation so far:                  ← 嵌套的 context
  - Carol: Instructions:                ← 再嵌套
    You are Carol...（系统指令第三遍）
    ...
```

### 修复
修复 Bug 4 后，此问题应自动解决。

---

## Bug 6: 所有 agent 后续轮次都缺少 [TEAM_TASK]

### 现象
- Claude (Max)：第三轮缺少 `[TEAM_TASK]`（Bug 3 已记录）
- Codex (Sarah)：第三轮缺少 `[TEAM_TASK]`（debug.log 第 517-601 行）
- Gemini (Carol)：第三轮缺少 Team Task 部分（debug.log 第 646-858 行）

### 根因
`ConversationCoordinator.ts` 的 `sendToAgent` 方法调用 `buildPrompt` 时没有传递 `teamTask` 参数。

与 Bug 3 是同一个问题，合并处理。

---

## Bug 7: (待记录)

---

## 日志文件位置
`/Users/kailaichen/Downloads/agent-chatter-test-folder/debug.log`
